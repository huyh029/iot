<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP32-CAM Simulator - Webcam</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: white;
      padding: 2rem;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 2rem; }
    .header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
    .header p { color: #94a3b8; font-size: 0.9rem; }
    
    .status-bar {
      display: flex; justify-content: center; gap: 2rem;
      margin-bottom: 2rem; flex-wrap: wrap;
    }
    .status-item {
      display: flex; align-items: center; gap: 0.5rem;
      padding: 0.5rem 1rem; background: rgba(255,255,255,0.1);
      border-radius: 2rem; font-size: 0.875rem;
    }
    .status-dot {
      width: 8px; height: 8px; border-radius: 50%;
      animation: pulse 2s infinite;
    }
    .status-dot.online { background: #22c55e; }
    .status-dot.offline { background: #ef4444; animation: none; }
    .status-dot.sending { background: #3b82f6; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .main-content { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; }
    @media (max-width: 900px) { .main-content { grid-template-columns: 1fr; } }
    
    .camera-section {
      background: #0f172a; border-radius: 1rem;
      overflow: hidden; border: 1px solid #334155;
    }
    .camera-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1rem; background: rgba(0,0,0,0.3); border-bottom: 1px solid #334155;
    }
    .camera-title { display: flex; align-items: center; gap: 0.5rem; font-weight: 600; }
    .live-badge {
      display: flex; align-items: center; gap: 0.375rem;
      padding: 0.25rem 0.75rem; border-radius: 0.25rem;
      font-size: 0.75rem; font-weight: 700;
    }
    .live-badge.active { background: #dc2626; }
    .live-badge.inactive { background: #475569; }
    
    .camera-view {
      position: relative; aspect-ratio: 16/9; background: #000;
      display: flex; align-items: center; justify-content: center;
    }
    #webcam-video {
      width: 100%; height: 100%; object-fit: cover;
      transform: scaleX(-1);
    }
    #placeholder { text-align: center; color: #64748b; }
    #placeholder .icon { font-size: 4rem; margin-bottom: 1rem; }
    
    .camera-overlay {
      position: absolute; top: 1rem; left: 1rem; right: 1rem;
      display: flex; justify-content: space-between; pointer-events: none;
    }
    .overlay-info {
      background: rgba(0,0,0,0.6); padding: 0.375rem 0.75rem;
      border-radius: 0.25rem; font-size: 0.75rem; font-family: monospace;
    }
    
    .camera-controls {
      display: flex; gap: 0.5rem; padding: 1rem;
      background: rgba(0,0,0,0.3); flex-wrap: wrap;
    }
    .control-btn {
      flex: 1; min-width: 100px; padding: 0.75rem; border: none;
      border-radius: 0.5rem; cursor: pointer; font-weight: 600;
      font-size: 0.875rem; display: flex; align-items: center;
      justify-content: center; gap: 0.5rem; transition: all 0.2s;
    }
    .control-btn.primary { background: #4cbe00; color: white; }
    .control-btn.danger { background: #dc2626; color: white; }
    .control-btn.secondary { background: #334155; color: white; }
    .control-btn.blue { background: #3b82f6; color: white; }
    .control-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .control-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .info-section { display: flex; flex-direction: column; gap: 1rem; }
    .info-card {
      background: #0f172a; border-radius: 1rem;
      padding: 1.25rem; border: 1px solid #334155;
    }
    .info-card h3 {
      font-size: 0.875rem; color: #94a3b8; margin-bottom: 1rem;
      text-transform: uppercase; letter-spacing: 0.05em;
    }
    .info-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.5rem 0; border-bottom: 1px solid #1e293b;
    }
    .info-row:last-child { border-bottom: none; }
    .info-label { color: #64748b; font-size: 0.875rem; }
    .info-value { font-weight: 600; font-family: monospace; color: #4cbe00; }
    
    .input-group { margin-bottom: 1rem; }
    .input-group label { display: block; font-size: 0.8rem; color: #94a3b8; margin-bottom: 0.375rem; }
    .input-group input, .input-group select {
      width: 100%; padding: 0.625rem; background: #1e293b;
      border: 1px solid #334155; border-radius: 0.5rem;
      color: white; font-size: 0.875rem;
    }
    .input-group input:focus, .input-group select:focus {
      outline: none; border-color: #4cbe00;
    }
    
    .url-box {
      background: #1e293b; border-radius: 0.5rem; padding: 0.75rem;
      font-family: monospace; font-size: 0.8rem; word-break: break-all;
      color: #4cbe00; margin-top: 0.5rem;
    }
    .copy-btn {
      width: 100%; margin-top: 0.75rem; padding: 0.625rem;
      background: #334155; border: none; border-radius: 0.5rem;
      color: white; cursor: pointer; font-size: 0.875rem;
    }
    .copy-btn:hover { background: #475569; }
    
    .alert {
      padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;
    }
    .alert.error { background: rgba(239,68,68,0.2); border: 1px solid #ef4444; color: #fca5a5; }
    .alert.success { background: rgba(34,197,94,0.2); border: 1px solid #22c55e; color: #86efac; }
    .alert.info { background: rgba(59,130,246,0.2); border: 1px solid #3b82f6; color: #93c5fd; }
    .alert.hidden { display: none; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-top: 1rem; }
    .stat-item { background: #1e293b; padding: 0.75rem; border-radius: 0.5rem; text-align: center; }
    .stat-value { font-size: 1.25rem; font-weight: 700; color: #4cbe00; }
    .stat-label { font-size: 0.7rem; color: #64748b; margin-top: 0.25rem; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üì∑ ESP32-CAM Webcam Simulator</h1>
      <p>Gi·∫£ l·∫≠p camera ESP32-CAM g·ª≠i stream l√™n Backend API</p>
    </div>
    
    <div id="alert" class="alert hidden"></div>
    
    <div class="status-bar">
      <div class="status-item">
        <span class="status-dot" id="status-dot"></span>
        <span id="status-text">Ch∆∞a k·∫øt n·ªëi</span>
      </div>
      <div class="status-item">
        <span id="resolution">--</span>
      </div>
      <div class="status-item">
        <span class="status-dot" id="api-dot"></span>
        <span id="api-status">API: Ch∆∞a g·ª≠i</span>
      </div>
    </div>
    
    <div class="main-content">
      <div class="camera-section">
        <div class="camera-header">
          <div class="camera-title">
            <span>üåø</span>
            <span id="camera-name">Smart Garden Camera</span>
          </div>
          <div class="live-badge inactive" id="live-badge">
            <span class="status-dot offline"></span>
            <span id="live-text">OFFLINE</span>
          </div>
        </div>
        
        <div class="camera-view">
          <video id="webcam-video" autoplay playsinline style="display:none;"></video>
          <div id="placeholder">
            <div class="icon">üì∑</div>
            <p>Nh·∫•n "B·∫≠t Camera" ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
            <p style="font-size: 0.8rem; margin-top: 0.5rem;">Tr√¨nh duy·ªát s·∫Ω y√™u c·∫ßu quy·ªÅn truy c·∫≠p camera</p>
          </div>
          <div class="camera-overlay">
            <div class="overlay-info" id="timestamp">--</div>
            <div class="overlay-info" id="device-id-display">--</div>
          </div>
        </div>
        
        <div class="camera-controls">
          <button class="control-btn primary" id="btn-start" onclick="startCamera()">
            ‚ñ∂ B·∫≠t Camera
          </button>
          <button class="control-btn danger" id="btn-stop" onclick="stopCamera()" disabled>
            ‚èπ T·∫Øt Camera
          </button>
          <button class="control-btn secondary" onclick="captureSnapshot()">
            üì∏ Ch·ª•p ·∫£nh
          </button>
          <button class="control-btn blue" id="btn-stream" onclick="toggleStreaming()" disabled>
            üì° G·ª≠i l√™n API
          </button>
        </div>
      </div>
      
      <div class="info-section">
        <!-- Device Config -->
        <div class="info-card">
          <h3>‚öôÔ∏è C·∫•u h√¨nh thi·∫øt b·ªã</h3>
          <div class="input-group">
            <label>Device ID (t·ª´ h·ªá th·ªëng backend)</label>
            <input type="text" id="device-id" placeholder="VD: ESP32_1_1" value="ESP32-CAM-001">
          </div>
          <div class="input-group">
            <label>Backend API URL</label>
            <input type="text" id="api-url" placeholder="https://beiot.onrender.com" value="https://beiot.onrender.com">
          </div>
          <div class="input-group">
            <label>Ch·ªçn Camera (Webcam)</label>
            <select id="camera-select" onchange="switchCamera()">
              <option value="">ƒêang t·∫£i...</option>
            </select>
          </div>
          <div class="input-group">
            <label>T·∫ßn su·∫•t g·ª≠i (ms)</label>
            <input type="number" id="send-interval" value="2000" min="500" max="10000">
          </div>
          <button class="copy-btn" onclick="saveConfig()">üíæ L∆∞u c·∫•u h√¨nh</button>
        </div>
        
        <!-- Stream URL -->
        <div class="info-card">
          <h3>üì° Stream URL</h3>
          <p style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">
            D√πng URL n√†y trong Smart Garden Manager ‚Üí Camera
          </p>
          <div class="url-box" id="stream-url">http://localhost:8081</div>
          <button class="copy-btn" onclick="copyUrl()">üìã Copy URL</button>
        </div>
        
        <!-- Stats -->
        <div class="info-card">
          <h3>üìä Th·ªëng k√™</h3>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value" id="frames-sent">0</div>
              <div class="stat-label">Frames ƒë√£ g·ª≠i</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="fps">0</div>
              <div class="stat-label">FPS</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="uptime">00:00</div>
              <div class="stat-label">Uptime</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="data-sent">0 KB</div>
              <div class="stat-label">Data g·ª≠i</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    let stream = null;
    let startTime = null;
    let uptimeInterval = null;
    let timestampInterval = null;
    let streamingInterval = null;
    let isStreaming = false;
    let isSending = false;
    let framesSent = 0;
    let totalDataSent = 0;
    let lastFpsTime = Date.now();
    let fpsFrameCount = 0;
    let socket = null;
    
    // Reusable canvas for better performance
    let canvas = null;
    let ctx = null;
    
    const video = document.getElementById('webcam-video');
    const placeholder = document.getElementById('placeholder');
    const cameraSelect = document.getElementById('camera-select');
    
    // Connect to WebSocket
    function connectWebSocket() {
      const apiUrl = document.getElementById('api-url').value || 'https://beiot.onrender.com';
      socket = io(apiUrl, { transports: ['websocket', 'polling'] });
      
      socket.on('connect', () => {
        console.log('‚úÖ WebSocket connected');
        document.getElementById('api-dot').className = 'status-dot online';
        document.getElementById('api-status').textContent = 'WS: ƒê√£ k·∫øt n·ªëi';
      });
      
      socket.on('disconnect', () => {
        console.log('‚ùå WebSocket disconnected');
        document.getElementById('api-dot').className = 'status-dot offline';
        document.getElementById('api-status').textContent = 'WS: M·∫•t k·∫øt n·ªëi';
      });
    }
    
    // Load saved config
    function loadConfig() {
      const savedDeviceId = localStorage.getItem('esp32cam_deviceId');
      const savedApiUrl = localStorage.getItem('esp32cam_apiUrl');
      const savedInterval = localStorage.getItem('esp32cam_interval');
      
      if (savedDeviceId) document.getElementById('device-id').value = savedDeviceId;
      if (savedApiUrl) document.getElementById('api-url').value = savedApiUrl;
      if (savedInterval) document.getElementById('send-interval').value = savedInterval;
      
      updateDeviceDisplay();
      connectWebSocket();
    }
    
    // Save config
    function saveConfig() {
      const deviceId = document.getElementById('device-id').value;
      const apiUrl = document.getElementById('api-url').value;
      const interval = document.getElementById('send-interval').value;
      
      localStorage.setItem('esp32cam_deviceId', deviceId);
      localStorage.setItem('esp32cam_apiUrl', apiUrl);
      localStorage.setItem('esp32cam_interval', interval);
      
      updateDeviceDisplay();
      
      // Reconnect WebSocket with new URL
      if (socket) socket.disconnect();
      connectWebSocket();
      showAlert('ƒê√£ l∆∞u c·∫•u h√¨nh!', 'success');
    }
    
    // Update device display
    function updateDeviceDisplay() {
      const deviceId = document.getElementById('device-id').value || 'ESP32-CAM-001';
      document.getElementById('device-id-display').textContent = deviceId;
      document.getElementById('camera-name').textContent = `Camera: ${deviceId}`;
    }
    
    // Get list of cameras
    async function getCameras() {
      try {
        await navigator.mediaDevices.getUserMedia({ video: true });
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');
        
        cameraSelect.innerHTML = '';
        videoDevices.forEach((device, index) => {
          const option = document.createElement('option');
          option.value = device.deviceId;
          option.text = device.label || `Camera ${index + 1}`;
          cameraSelect.appendChild(option);
        });
        
        if (videoDevices.length === 0) {
          cameraSelect.innerHTML = '<option value="">Kh√¥ng t√¨m th·∫•y camera</option>';
        }
      } catch (err) {
        console.error('Error getting cameras:', err);
        cameraSelect.innerHTML = '<option value="">L·ªói: ' + err.message + '</option>';
      }
    }
    
    // Start camera
    async function startCamera() {
      try {
        showAlert('', 'hidden');
        
        const constraints = {
          video: {
            deviceId: cameraSelect.value ? { exact: cameraSelect.value } : undefined,
            width: { ideal: 320 },  // Reduced for performance
            height: { ideal: 240 }
          },
          audio: false
        };
        
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        
        video.onloadedmetadata = () => {
          video.style.display = 'block';
          placeholder.style.display = 'none';
          
          const track = stream.getVideoTracks()[0];
          const settings = track.getSettings();
          
          document.getElementById('resolution').textContent = `${settings.width}x${settings.height}`;
          document.getElementById('status-dot').className = 'status-dot online';
          document.getElementById('status-text').textContent = 'Camera ON';
          document.getElementById('live-badge').className = 'live-badge active';
          document.getElementById('live-text').textContent = 'LIVE';
          document.querySelector('#live-badge .status-dot').className = 'status-dot online';
          
          document.getElementById('btn-start').disabled = true;
          document.getElementById('btn-stop').disabled = false;
          document.getElementById('btn-stream').disabled = false;
          
          startTime = Date.now();
          uptimeInterval = setInterval(updateUptime, 1000);
          timestampInterval = setInterval(updateTimestamp, 1000);
          updateTimestamp();
          
          showAlert('Camera ƒë√£ b·∫≠t!', 'success');
        };
        
      } catch (err) {
        console.error('Error starting camera:', err);
        showAlert('L·ªói: ' + err.message, 'error');
      }
    }
    
    // Stop camera
    function stopCamera() {
      if (isStreaming) toggleStreaming();
      
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      
      video.srcObject = null;
      video.style.display = 'none';
      placeholder.style.display = 'block';
      
      document.getElementById('resolution').textContent = '--';
      document.getElementById('status-dot').className = 'status-dot offline';
      document.getElementById('status-text').textContent = 'Ch∆∞a k·∫øt n·ªëi';
      document.getElementById('live-badge').className = 'live-badge inactive';
      document.getElementById('live-text').textContent = 'OFFLINE';
      document.querySelector('#live-badge .status-dot').className = 'status-dot offline';
      document.getElementById('timestamp').textContent = '--';
      
      document.getElementById('btn-start').disabled = false;
      document.getElementById('btn-stop').disabled = true;
      document.getElementById('btn-stream').disabled = true;
      
      if (uptimeInterval) clearInterval(uptimeInterval);
      if (timestampInterval) clearInterval(timestampInterval);
      
      showAlert('Camera ƒë√£ t·∫Øt', 'success');
    }
    
    // Switch camera
    async function switchCamera() {
      if (stream) {
        stopCamera();
        await startCamera();
      }
    }
    
    // Toggle streaming to API
    function toggleStreaming() {
      if (isStreaming) {
        // Stop streaming
        if (streamingInterval) clearInterval(streamingInterval);
        isStreaming = false;
        
        document.getElementById('btn-stream').textContent = 'üì° G·ª≠i l√™n API';
        document.getElementById('btn-stream').className = 'control-btn blue';
        document.getElementById('api-dot').className = 'status-dot offline';
        document.getElementById('api-status').textContent = 'API: ƒê√£ d·ª´ng';
        
        showAlert('ƒê√£ d·ª´ng g·ª≠i stream', 'info');
      } else {
        // Start streaming
        const interval = parseInt(document.getElementById('send-interval').value) || 1500;
        
        isStreaming = true;
        framesSent = 0;
        totalDataSent = 0;
        lastFpsTime = Date.now();
        fpsFrameCount = 0;
        
        streamingInterval = setInterval(sendFrame, interval);
        
        document.getElementById('btn-stream').textContent = '‚èπ D·ª´ng g·ª≠i';
        document.getElementById('btn-stream').className = 'control-btn danger';
        document.getElementById('api-dot').className = 'status-dot sending';
        document.getElementById('api-status').textContent = 'WS: ƒêang g·ª≠i...';
        
        // Initialize canvas once
        if (!canvas) {
          canvas = document.createElement('canvas');
          ctx = canvas.getContext('2d');
        }
        
        showAlert('B·∫Øt ƒë·∫ßu g·ª≠i stream qua WebSocket', 'success');
      }
    }
    
    // Send frame via WebSocket (fast, no HTTP overhead)
    function sendFrame() {
      if (!stream || !isStreaming || !socket || !socket.connected) return;
      if (video.videoWidth === 0 || video.videoHeight === 0) return;
      
      try {
        // Reuse canvas, scale down for performance
        const targetWidth = Math.min(video.videoWidth, 320);
        const targetHeight = Math.min(video.videoHeight, 240);
        
        canvas.width = targetWidth;
        canvas.height = targetHeight;
        
        ctx.translate(targetWidth, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, targetWidth, targetHeight);
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        
        // Convert to base64 JPEG
        const imageData = canvas.toDataURL('image/jpeg', 0.5);
        const base64Data = imageData.split(',')[1];
        
        const deviceId = document.getElementById('device-id').value || 'ESP32-CAM-001';
        
        // Send via WebSocket (much faster than HTTP)
        socket.emit('camera-frame-upload', {
          deviceId: deviceId,
          frame: base64Data,
          timestamp: new Date().toISOString(),
          width: targetWidth,
          height: targetHeight
        });
        
        framesSent++;
        fpsFrameCount++;
        totalDataSent += base64Data.length;
        
        document.getElementById('frames-sent').textContent = framesSent;
        document.getElementById('data-sent').textContent = formatBytes(totalDataSent);
        document.getElementById('api-dot').className = 'status-dot online';
        document.getElementById('api-status').textContent = `WS: OK (${framesSent})`;
        
        // Calculate FPS
        const now = Date.now();
        if (now - lastFpsTime >= 1000) {
          document.getElementById('fps').textContent = fpsFrameCount;
          fpsFrameCount = 0;
          lastFpsTime = now;
        }
      } catch (err) {
        console.error('Error sending frame:', err);
        document.getElementById('api-dot').className = 'status-dot offline';
        document.getElementById('api-status').textContent = 'WS: L·ªói';
      }
    }
    
    // Format bytes
    function formatBytes(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    // Capture snapshot
    function captureSnapshot() {
      if (!stream) {
        showAlert('Vui l√≤ng b·∫≠t camera tr∆∞·ªõc', 'error');
        return;
      }
      
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      const ctx = canvas.getContext('2d');
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, 0, 0);
      
      const link = document.createElement('a');
      const deviceId = document.getElementById('device-id').value || 'ESP32-CAM';
      link.download = `${deviceId}-${Date.now()}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
      
      showAlert('ƒê√£ l∆∞u ·∫£nh!', 'success');
    }
    
    // Update timestamp
    function updateTimestamp() {
      const now = new Date();
      document.getElementById('timestamp').textContent = 
        now.toLocaleDateString('vi-VN') + ' ' + now.toLocaleTimeString('vi-VN');
    }
    
    // Update uptime
    function updateUptime() {
      if (!startTime) return;
      
      const elapsed = Date.now() - startTime;
      const minutes = Math.floor(elapsed / 60000);
      const seconds = Math.floor((elapsed % 60000) / 1000);
      
      document.getElementById('uptime').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Copy URL
    function copyUrl() {
      const url = document.getElementById('stream-url').textContent;
      navigator.clipboard.writeText(url).then(() => {
        event.target.textContent = '‚úÖ ƒê√£ copy!';
        setTimeout(() => { event.target.textContent = 'üìã Copy URL'; }, 2000);
      });
    }
    
    // Show alert
    function showAlert(message, type) {
      const alert = document.getElementById('alert');
      alert.textContent = message;
      alert.className = `alert ${type}`;
      
      if (type !== 'hidden') {
        setTimeout(() => { alert.className = 'alert hidden'; }, 3000);
      }
    }
    
    // Initialize
    document.getElementById('stream-url').textContent = window.location.href;
    loadConfig();
    getCameras();
    
    // Update device display when input changes
    document.getElementById('device-id').addEventListener('input', updateDeviceDisplay);
  </script>
</body>
</html>
